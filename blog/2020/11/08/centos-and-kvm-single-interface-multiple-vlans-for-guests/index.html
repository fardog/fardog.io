<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Nathan Wittstock">
<meta name="description" content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that&rsquo;s transparent to KVM guests.">

<meta property="og:title" content="CentOS and KVM: Single interface, multiple VLANs for Guests" />
<meta property="og:description" content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that&rsquo;s transparent to KVM guests." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fardog.io/blog/2020/11/08/centos-and-kvm-single-interface-multiple-vlans-for-guests/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-08T01:55:00-08:00" />
<meta property="article:modified_time" content="2020-11-08T01:55:00-08:00" />



<title>


     CentOS and KVM: Single interface, multiple VLANs for Guests 

</title>
<link rel="canonical" href="https://fardog.io/blog/2020/11/08/centos-and-kvm-single-interface-multiple-vlans-for-guests/">










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/pygments.css">
    <link rel="stylesheet" href="/css/main.css">
    




<link rel="shortcut icon"

    href="/favicon.ico"

>








</head>


<body lang="en">

<section class="header">
    <div class="container">
        <div class="content">
            
                
                
                
                
                
                    
                
                    
                
                
                <a href="/"><img class="avatar" src="/img/profile.jpg" srcset="https://fardog.io/img/profile.jpg 1x"></a>
            
            <a href="/"><div class="name">Nathan Wittstock</div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-projects"><a href="https://fardog.io/projects/"><span>Projects</span></a></li>
                    
                        <li class="nav-blog"><a href="https://fardog.io/blog/"><span>Blog</span></a></li>
                    
                        <li class="nav-contact"><a href="https://fardog.io/contact/"><span>Contact</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/fardog" target="_blank" rel="noopener"><img class="icon" src="/img/github.svg" alt="github" /></a>
        

        

        

        

        

        

        

        

        

        

        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    CentOS and KVM: Single interface, multiple VLANs for Guests

</div>

                    <div class="initials"><a href="https://fardog.io/"></a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Sun Nov 8 2020 01:55:00 -0800'>Nov 8, 2020</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>2 minutes read</div>
                    
                </div>
            </div>
            <div class="markdown">
                <p>KVM on Linux is a nice way to run isolated services on your home network;
in my case: MySQl, a Unifi controller, various Docker containers, etc.
However: if you want to run these services on different VLANs so they can be
in isolated networks, the process is less straightforward. This document covers
how to get CentOS network interfaces set up so multiple VLANs can co-exist
on a single interface in a way that&rsquo;s transparent to KVM guests.</p>
<p><strong>Note:</strong> This is mostly notes for my own memory, I may come back later and
clean this up into more of a &ldquo;how-to&rdquo; article. As it stands, this will probably
get you going if you are as stuck as I was. This document covers CentOS 8.2 but
should work on Red Hat, Fedora, etc.</p>
<h1 id="network-scripts">Network Scripts</h1>
<p>Create a network configuration definition for your primary interface; this will
be named after the interface name, which you can retrieve with an
<code>ip link show</code>; in my case, it&rsquo;s <code>enp0s25</code>. Replace those file and interface
names with whatever interface you&rsquo;ll be using.</p>
<p>Configure the bridge interface; use your own network information as appropriate.
This will be the primary IP address of your CentOS server:</p>
<pre tabindex="0"><code># /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE=br0
TYPE=Bridge
IPADDR=172.16.18.10
NETMASK=255.255.255.0
GATEWAY=172.16.18.254
DNS1=172.168.18.1
ONBOOT=yes
DEFROUTE=yes
BOOTPROTO=static
DELAY=0
DOMAIN=&#34;lan.mydomain.example&#34;
</code></pre><p>Configure your interface to use the newly created <code>br0</code>:</p>
<pre tabindex="0"><code># /etc/sysconfig/network-scripts/ifcfg-enp0s25
DEVICE=&#34;enp0s25&#34; # replace with your interface name
TYPE=Ethernet
HWADDR=ff:ff:ff:ff:ff:ff  # replace with your hardware address
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0
</code></pre><p>Configure a bridge for each VLAN you wish to use; the <code>127</code> you see here is an
example and should be replaced with the number of your VLAN:</p>
<pre tabindex="0"><code># /etc/sysconfig/network-scripts/ifcfg-br0.127
DEVICE=br0.127
TYPE=Bridge
IPADDR=172.16.19.10
NETMASK=255.255.255.0
ONBOOT=yes
BOOTPROTO=static
DELAY=0
VLAN=yes
</code></pre><p>Now create an interface for that VLAN and bridge:</p>
<pre tabindex="0"><code># /etc/sysconfig/network-scripts/ifcfg-enp0s25.127
DEVICE=&#34;enp0s25.127&#34;
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0.127
USERCTL=no
VLAN=yes
</code></pre><p>Now reboot your system; when it comes back up, you should have the new
interfaces you configured available, and it should be pingable at the primary
and VLAN addresses. Do this for as many VLANs as you need to cover.</p>
<p>When configuring new guests via the CentOS &ldquo;Virtual Machine&rdquo; manager, you should
be able to select the VLAN bridge as the host interface. When your guest boots,
it will now be on that selected VLAN without any additional configuration
necessaryâ€”and will support DHCP and all expected network features.</p>

                <br>
		<p class="back-to-posts"><a href="/blog/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>








<section class="footer">
    <div class="container">
        <div class="content">
            <p>&copy; 2022 Nathan Wittstock &mdash; Content: <a href="https://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>, Code: <a href="https://github.com/fardog/fardog.io/blob/master/LICENSE">MIT</a>, unless otherwise noted.</p>
            <p>
                View the <a href="https://github.com/fardog/fardog.io">source</a> for this site.
                
                    <a href="/privacy/">Privacy</a>.
                
            </p>
        </div>
    </div>
</section>
</body>
</html>

