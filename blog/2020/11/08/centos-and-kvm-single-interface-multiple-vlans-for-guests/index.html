<!doctype html><html lang=en-us><head><title>CentOS and KVM: Single interface, multiple VLANs for Guests | fardog.io</title>
<meta name=generator content="Hugo 0.128.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="dark light"><meta name=author content="Nathan Wittstock"><meta name=description content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that&rsquo;s transparent to KVM guests."><meta name=referrer content="no-referrer"><link rel=canonical href=https://fardog.io/blog/2020/11/08/centos-and-kvm-single-interface-multiple-vlans-for-guests/><link rel="shortcut icon" type=image/vnd.microsoft.icon href=/favicon.ico><link rel=stylesheet href=/main.min.9637009c6b01416517e2b0e76a0530c7038e1c72499cd53ae621955c3631a6f5a07d4c5b7de66c4c27dfa27d92de278cc57ac5e5994409027ddc733b09dec622.css integrity="sha512-ljcAnGsBQWUX4rDnagUwxwOOHHJJnNU65iGVXDYxpvWgfUxbfeZsTCffon2S3ieMxXrF5ZlECQJ93HM7Cd7GIg=="><meta itemprop=name content="CentOS and KVM: Single interface, multiple VLANs for Guests"><meta itemprop=description content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that’s transparent to KVM guests."><meta itemprop=datePublished content="2020-11-08T01:55:00-08:00"><meta itemprop=dateModified content="2020-11-08T01:55:00-08:00"><meta itemprop=wordCount content="383"><meta property="og:url" content="https://fardog.io/blog/2020/11/08/centos-and-kvm-single-interface-multiple-vlans-for-guests/"><meta property="og:site_name" content="fardog.io"><meta property="og:title" content="CentOS and KVM: Single interface, multiple VLANs for Guests"><meta property="og:description" content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that’s transparent to KVM guests."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-11-08T01:55:00-08:00"><meta property="article:modified_time" content="2020-11-08T01:55:00-08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CentOS and KVM: Single interface, multiple VLANs for Guests"><meta name=twitter:description content="KVM on Linux is a nice way to run isolated services on your home network; in my case: MySQl, a Unifi controller, various Docker containers, etc. However: if you want to run these services on different VLANs so they can be in isolated networks, the process is less straightforward. This document covers how to get CentOS network interfaces set up so multiple VLANs can co-exist on a single interface in a way that’s transparent to KVM guests."></head><body><header><nav><a title="Return to Blog" href=/blog/>&larr; Blog</a></nav><h1>CentOS and KVM: Single interface, multiple VLANs for Guests</h1></header><main><p>KVM on Linux is a nice way to run isolated services on your home network;
in my case: MySQl, a Unifi controller, various Docker containers, etc.
However: if you want to run these services on different VLANs so they can be
in isolated networks, the process is less straightforward. This document covers
how to get CentOS network interfaces set up so multiple VLANs can co-exist
on a single interface in a way that&rsquo;s transparent to KVM guests.</p><p><strong>Note:</strong> This is mostly notes for my own memory, I may come back later and
clean this up into more of a &ldquo;how-to&rdquo; article. As it stands, this will probably
get you going if you are as stuck as I was. This document covers CentOS 8.2 but
should work on Red Hat, Fedora, etc.</p><h1 id=network-scripts>Network Scripts</h1><p>Create a network configuration definition for your primary interface; this will
be named after the interface name, which you can retrieve with an
<code>ip link show</code>; in my case, it&rsquo;s <code>enp0s25</code>. Replace those file and interface
names with whatever interface you&rsquo;ll be using.</p><p>Configure the bridge interface; use your own network information as appropriate.
This will be the primary IP address of your CentOS server:</p><pre tabindex=0><code># /etc/sysconfig/network-scripts/ifcfg-br0
DEVICE=br0
TYPE=Bridge
IPADDR=172.16.18.10
NETMASK=255.255.255.0
GATEWAY=172.16.18.254
DNS1=172.168.18.1
ONBOOT=yes
DEFROUTE=yes
BOOTPROTO=static
DELAY=0
DOMAIN=&#34;lan.mydomain.example&#34;
</code></pre><p>Configure your interface to use the newly created <code>br0</code>:</p><pre tabindex=0><code># /etc/sysconfig/network-scripts/ifcfg-enp0s25
DEVICE=&#34;enp0s25&#34; # replace with your interface name
TYPE=Ethernet
HWADDR=ff:ff:ff:ff:ff:ff  # replace with your hardware address
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0
</code></pre><p>Configure a bridge for each VLAN you wish to use; the <code>127</code> you see here is an
example and should be replaced with the number of your VLAN:</p><pre tabindex=0><code># /etc/sysconfig/network-scripts/ifcfg-br0.127
DEVICE=br0.127
TYPE=Bridge
IPADDR=172.16.19.10
NETMASK=255.255.255.0
ONBOOT=yes
BOOTPROTO=static
DELAY=0
VLAN=yes
</code></pre><p>Now create an interface for that VLAN and bridge:</p><pre tabindex=0><code># /etc/sysconfig/network-scripts/ifcfg-enp0s25.127
DEVICE=&#34;enp0s25.127&#34;
BOOTPROTO=none
ONBOOT=yes
BRIDGE=br0.127
USERCTL=no
VLAN=yes
</code></pre><p>Now reboot your system; when it comes back up, you should have the new
interfaces you configured available, and it should be pingable at the primary
and VLAN addresses. Do this for as many VLANs as you need to cover.</p><p>When configuring new guests via the CentOS &ldquo;Virtual Machine&rdquo; manager, you should
be able to select the VLAN bridge as the host interface. When your guest boots,
it will now be on that selected VLAN without any additional configuration
necessary—and will support DHCP and all expected network features.</p></main><footer role=contentinfo>© 2024 Nathan Wittstock
—
Content: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a>,
Code: <a href=https://github.com/fardog/fardog.io/blob/master/LICENSE target=_blank>MIT</a>, unless otherwise noted.<p>View the
<a href=https://github.com/fardog/fardog.io/ target=_blank>source</a>
for this site.
<a href=https://fardog.io/privacy/>Privacy</a>.</p></footer></body></html>